
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>CarverLink!!</title>
	<!-- <script id ="addyList" src="addy.csv"></script> -->
    <script src="https://js.arcgis.com/calcite-components/1.4.2/calcite.esm.js" type="module"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.4.2/calcite.css" />

    <!-- <script src="https://js.arcgis.com/4.26/"></script> -->
    <!-- <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" /> -->
	
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
 
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0px;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>
  <body> 
	<calcite-shell content-behind >
	<calcite-combobox id="address-select" placeholder="Enter An Address!" selection-mode="single" on></calcite-combobox>
		<!-- <calcite-shell-panel slot="panel-start" display-mode="float"> -->
		<!-- </calcite-shell-panel> -->
		<div id="viewDiv"><div id="map" class="hidem"></div></div>
	</calcite-shell>

 <script>
      const apiKey = "AAPKaea27064e50c4ad1a90b2d34e03ba8f5jFvKxjZjOlhObw6kONRLgO7M0KTU5jkMJIlqH4XB8nbaTARSJSlAMM9TJ3DbPzwg";

      const map = L.map("map", {
        minZoom: 2
      }).setView([44.8, -93.85], 19); //Latitude, longitude

      L.esri
        .tiledMapLayer({
          url: "https://tiles.arcgis.com/tiles/wMZT8kNwa6tOxhKg/arcgis/rest/services/2022_Tiled_Imagery_282/MapServer",
		  apiKey: apiKey,
          detectRetina: false,
          minZoom: 3,
          maxZoom: 19
        }).addTo(map);

	const popup = L.popup()
		.setLatLng([44.7, -93.2])
		.setContent('I am a standalone popup.')
		.openOn(map);

    </script>
  </body>	
  <script>
  window.addEventListener('load', () => {
  
    const addressCombobox = document.getElementById('address-select');
    addressCombobox.addEventListener("calciteComboboxFilterChange", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxFilterChange");
    });
	
	addressCombobox.addEventListener("calciteComboboxItemChange", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxItemChange");
		console.log(addressCombobox.value);
		console.log(queryFeatures);
		
		for (var iIndex = 0; iIndex < queryFeatures.length; ++iIndex){
			iFeature = queryFeatures[iIndex];
			thisAddy = iFeature.properties.Street+" "+iFeature.properties.City;
			if (thisAddy == addressCombobox.value){
				console.log(iFeature);
				console.log("Zoom!");
			}
		}
						
    });	
	 addressCombobox.addEventListener("calciteComboboxBeforeClose", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxBeforeClose");
    });

	 addressCombobox.addEventListener("calciteComboboxBeforeOpen", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxBeforeOpen");
    });

	 addressCombobox.addEventListener("calciteComboboxChipClose", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxChipClose");
    });

	 addressCombobox.addEventListener("calciteComboboxClose", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxClose");
    });

	 addressCombobox.addEventListener("calciteComboboxFilterChange", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxFilterChange");
		dbgMess(theKey);
    });

	 addressCombobox.addEventListener("calciteComboboxOpen", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxOpen");
    });
		
	
	addressCombobox.addEventListener("keyup",function(e){
		console.log("keyup");
		console.log(theKey);
		console.log(theString);
		if ("abcdefghijklmnopqrstuvwxyz1234567890 ///".includes(theKey.toLowerCase())){
			theString+= theKey;
			dbgMess(theString);
			popit(theString,true);
		} else {
		   dbgMess("Skip");
	    }
		theKey = "";
		
	});
	addressCombobox.addEventListener("keydown",function(e){
		console.log("keydown");
		console.log(e.key);
		theKey = e.key;
	});
	
	var theString = "";
	var theKey = "";
    var queryFeatures = "";
     function popit(iVal,iOpen=true){
				var tmpVal = "1";
				console.log(iVal);
				var theWhere = "Street like '"+iVal+"%'";console.log(theWhere);
				var query = L.esri.query({
				   url: 'https://services.arcgis.com/wMZT8kNwa6tOxhKg/ArcGIS/rest/services/addy_20230622_ago/FeatureServer/0'
				});

				query.where(theWhere);
				query.returnGeometry(false);
				query.orderBy("Street");
				query.limit(25);
			const combobox = document.getElementById("address-select");
				query.run(function (error, featureCollection, response) {
					if (error) {
					   console.log(error);
					   return;
					}
					combobox.innerHTML = "";
					queryFeatures = featureCollection.features;
					<!-- zzz=  features; -->
					//console.log(features);
					var addressList = [];
					
					for (var iIndex = 0; iIndex < queryFeatures.length; ++iIndex){
						iFeature = queryFeatures[iIndex];
						thisAddy = iFeature.properties.Street+" "+iFeature.properties.City;
						addressList.push({name:thisAddy, id:thisAddy});
						const item = document.createElement("calcite-combobox-item");
						item.value = thisAddy;
						item.textLabel = thisAddy;
						combobox.appendChild(item);
					}
					combobox.open = (iOpen == true);
					combobox.setFocus();
			});
}
	
	function dbgMess(i){
		console.log(i);
	}	

	popit(1,false);
  }, false);
</script>

</html>