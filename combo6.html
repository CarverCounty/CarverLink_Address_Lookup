
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>CarverLink Broadband Efforts</title>
    <script src="https://js.arcgis.com/calcite-components/1.4.2/calcite.esm.js" type="module"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.4.2/calcite.css" />
	
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
 
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>

  </head>
  <style>
    html,
      body {
        margin: 0;
        padding: 0;
      }
    #viewDiv {
      padding: 0px;
      margin: 0;
      height: 100%;
      width: 100%;
    }
	
	#map {
        position: absolute;
        top: 30px;
        bottom: 0	;
        right: 0;
        left: 0;
        font-family: Arial, Helvetica, sans-serif;	
        font-size: 14px;
        color: #323232;
		<!-- visibility: hidden; -->
      }
	  
	  	  .hide {
	     visibility: hidden;
	  }
	  .show {
	   visibility: block;
	  }
  </style>
  <body> 
	<calcite-combobox id="address-select" placeholder="Enter your address" selection-mode="single"></calcite-combobox>
	<div id="map" class="hide"></div>
    <calcite-alert icon="map-pin" kind="brand"  label="" id="serviceAlert">
        <div id= "zoneTitle" slot="title"></div>
        <div id= "zoneMessage" slot="message"></div>
    </calcite-alert>
	<script>
      const apiKey = "AAPKaea27064e50c4ad1a90b2d34e03ba8f5jFvKxjZjOlhObw6kONRLgO7M0KTU5jkMJIlqH4XB8nbaTARSJSlAMM9TJ3DbPzwg";
      const map = L.map("map", {
			minZoom: 2
      }).setView([44.8, -93.85], 19);

      L.esri
        .tiledMapLayer({
          url: "https://tiles.arcgis.com/tiles/wMZT8kNwa6tOxhKg/arcgis/rest/services/2022_Tiled_Imagery_282/MapServer",
		  apiKey: apiKey,
          detectRetina: false,
          minZoom: 3,
          maxZoom: 19
        }).addTo(map);
    </script>
  </body>


  <script>
  window.addEventListener('load', () => {
  
    const addressCombobox = document.getElementById('address-select');
	
	addressCombobox.addEventListener("focus", (e) => {
		dbgMess("focus");
    });
	
	addressCombobox.addEventListener("blur", (e) => {
		dbgMess("blur");
    });
	
    addressCombobox.addEventListener("calciteComboboxFilterChange", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxFilterChange");
    });
	
	function zoomToAddy(inAddy){
		for (var iIndex = 0; iIndex < queryFeatures.length; ++iIndex){
			iFeature = queryFeatures[iIndex];
			thisAddy = iFeature.properties.SITEADDRESS+", "+iFeature.properties.USPS_PLACE;
			if (thisAddy == inAddy){
				console.log(iFeature);
				console.log("Zoom!");
			    var theX = iFeature.properties.x;
			    var theY = iFeature.properties.y;
			    var theZone = iFeature.properties.Info;
			    map.panTo({lng:theX, lat:theY});

			   var carverIcon = L.icon({
               iconUrl: 'img/CCMarker.png',

					iconSize:     [40, 60], // size of the icon
					shadowSize:   [50, 64], // size of the shadow
					iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
					popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
				});
			   document.getElementById("map").classList.remove('hide');
			   document.getElementById("map").classList.add('show');
				document.querySelector("#zoneTitle").innerHTML = thisAddy;
				document.querySelector("#zoneMessage").innerHTML = theZone; //"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Arcu non odio euismod lacinia at quis risus. Ac tortor dignissim convallis aenean et tortor at risus. Purus semper eget duis at tellus at urna condimentum. Justo laoreet sit amet cursus sit. Dictum fusce ut placerat orci nulla pellentesque. Volutpat blandit aliquam etiam erat. Amet nisl suscipit adipiscing bibendum est ultricies integer quis. In nulla posuere sollicitudin aliquam ultrices sagittis orci. Quam quisque id diam vel quam elementum pulvinar. Adipiscing vitae proin sagittis nisl rhoncus mattis rhoncus urna. Euismod lacinia at quis risus. Mattis nunc sed blandit libero volutpat sed cras. Nulla pharetra diam sit amet nisl suscipit adipiscing bibendum est. Fringilla ut morbi tincidunt augue interdum velit. Eleifend donec pretium vulputate sapien nec sagittis aliquam. Eu volutpat odio facilisis mauris sit.";
				document.querySelector("#serviceAlert").setAttribute("open",true)
				console.log("##################################################");
				if (typeof(tmpMarker) != "undefined"){
					tmpMarker.remove()
				}
				
				tmpMarker = L.marker([theY, theX], {icon: carverIcon});
				tmpMarker.addTo(map);
				theString = "";
				document.getElementById("address-select").innerHTML = "";
				const combobox = document.getElementById("address-select");
				combobox.open = false;
			}
		}	
	}
	
	addressCombobox.addEventListener("calciteComboboxItemChange", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxItemChange");
		zoomToAddy(addressCombobox.value);					
    });	
	
	 addressCombobox.addEventListener("calciteComboboxBeforeClose", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxBeforeClose");
    });

	 addressCombobox.addEventListener("calciteComboboxBeforeOpen", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxBeforeOpen");
    });

	 addressCombobox.addEventListener("calciteComboboxChipClose", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxChipClose");
    });

	 addressCombobox.addEventListener("calciteComboboxChipDismiss", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxChipDismiss");
    });

	 addressCombobox.addEventListener("calciteLookupChange", calciteComboboxChangeEvt => {
		dbgMess("calciteLookupChange");
    });
	
	 addressCombobox.addEventListener("calciteComboboxClose", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxClose");
    });

	 addressCombobox.addEventListener("calciteComboboxChange", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxChange");
    });
	
	 addressCombobox.addEventListener("calciteComboboxFilterChange", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxFilterChange");
		dbgMess(theKey);
    });

	 addressCombobox.addEventListener("calciteComboboxOpen", calciteComboboxChangeEvt => {
		dbgMess("calciteComboboxOpen");
    });
		
	
	addressCombobox.addEventListener("keyup",function(e){
		console.log("keyup");
		
		var refreshIt = false;
		for (var iIndex = 0; iIndex < keyArray.length; ++iIndex){
			var iKey = keyArray[iIndex];
			
			if ("abcdefghijklmnopqrstuvwxyz1234567890 ///".includes(iKey.toLowerCase())){
				theString+= iKey;
				dbgMess(theString);
				refreshIt = true;
			}
			
			if (iKey == "Backspace"){
			  if (theString.length>1){
				theString = theString.substring(0,theString.length-1);
				refreshIt = true;
			  } else {
				 if (theString.length==1){
					theString= "";
					refreshIt = true;
				 }
			  }
			}
			
			if (iKey == "Escape"){
					theString= "";
					refreshIt = true;
			}

			if (iKey == "Enter"){
					theString= "";
					zoomToAddy(addressCombobox.value);
					refreshIt = false;
			}
			
			if (refreshIt==true){
			   popit(theString,true);
			}
		}
		theKey = "";
		keyArray = [];
		
	});
	
	addressCombobox.addEventListener("keydown",function(e){
		console.log("keydown");
		theKey = e.key;
		keyArray.push(e.key);
	});
	
	var theString = "";
	var theKey = "";
	var keyArray = [];
    var queryFeatures = "";
	
    function popit(iVal,iOpen=true){
		var tmpVal = "1";

		var theWhere = "SITEADDRESS like '"+iVal+"%'";console.log(theWhere);
		var query = L.esri.query({
		   url: 'https://services.arcgis.com/wMZT8kNwa6tOxhKg/arcgis/rest/services/CUCI_Addresses_20230627_publicView/FeatureServer/0'
		});

		query.where(theWhere);
		query.returnGeometry(false);
		query.orderBy("SITEADDRESS");
		query.limit(25);
			
		const combobox = document.getElementById("address-select");
		query.run(function (error, featureCollection, response) {
			if (error) {
			   console.log(error);
			   return;
			}
			combobox.innerHTML = "";
			queryFeatures = featureCollection.features;

			var addressList = [];
			
			for (var iIndex = 0; iIndex < queryFeatures.length; ++iIndex){
				iFeature = queryFeatures[iIndex];
				thisAddy = iFeature.properties.SITEADDRESS+", "+iFeature.properties.USPS_PLACE;
				addressList.push({name:thisAddy, id:thisAddy});
				const item = document.createElement("calcite-combobox-item");
				item.value = thisAddy;
				item.textLabel = thisAddy;
				combobox.appendChild(item);
			}
			combobox.open = (iOpen == true);
			combobox.setFocus();
				
		});
}
	
	function dbgMess(i){
		console.log(i);
	}
  }, false);
</script>

</html>