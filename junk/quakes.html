<!-- https://developers.arcgis.com/javascript/latest/api-reference/esri-form-elements-inputs-ComboBoxInput.html -->
<!-- https://developers.arcgis.com/calcite-design-system/components/input/ -->
<html lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>CarverLink Addy Lookupz</title>

    <script src="https://js.arcgis.com/calcite-components/1.4.2/calcite.esm.js" type="module"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.4.2/calcite.css" />
    <script src="https://js.arcgis.com/4.26/"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" />

  </head>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0px;
      margin: 0;
      height: 100%;
      width: 100%;
    }

  </style>

  <body>
    <main>
    <calcite-shell>
      <!-- Panel to display records -->
      <calcite-panel heading="Address Look-Up" heading-level="1" description="">
        <calcite-filter placeholder="Enter Your Address.."></calcite-filter>
      </calcite-panel>
	    <calcite-combobox id="address-select" placeholder="Enter An Address!" selection-mode="single" on>
		</calcite-combobox>
		<div id="viewDiv"></div>
    </calcite-shell>
    </main>
  </body>
  
   <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
	  "esri/config"		  
    ], function(WebMap, MapView, esriConfig ) {
		<!-- esriConfig.apiKey = "YOUR_API_KEY"; -->
      const webmapId = new URLSearchParams(window.location.search).get("webmap")
        ?? "8f67432164eb4dcba08eef1d01dbbad7";
	document.getElementById('viewDiv').style.visibility = 'hidden'
      const map = new WebMap({
        portalItem: {
          id: webmapId
        }
      });

	  const view = new MapView({
        map,
        container: "viewDiv",
        padding: {
          left: 49
        }
      });

	  view.when().then(function () { 
		  classSelect = document.getElementById("address-select");
		  classSelect.addEventListener("change", generateRenderer); 
	  }); 
	  function generateRenderer() {              
          const fieldLabel = classSelect.selectedItems[0].innerText;
          console.info("change: ", fieldLabel)
	  }


    });
  </script>
  
  <script>
  const filterElement = document.querySelector("calcite-filter");
  var file = new XMLHttpRequest();	
	
	function populateList(inText){
		var rows = inText.split(/\n/);
		var items = []
		addyDict = {}
		var dirList = new Array("north","south","east","west","northeast","southeast","northwest","southwest");
		for (var rowIndex = 0; rowIndex < rows.length; ++rowIndex){ 
			var iRow = rows[rowIndex];
			var thisAddy = iRow.split(",")[0]+", "+iRow.split(",")[1]
			var i = {"siteaddress": thisAddy};
			items.push(i);
			addyDict[thisAddy] = {"zone": iRow.split(",")[2]}
			
			for (var dirIndex = 0; dirIndex < dirList.length; ++dirIndex){
				var iDir = " "+dirList[dirIndex].toLowerCase()+",";
				
					if ((iRow.split(",")[0].toLowerCase()+",").includes(" "+iDir.toLowerCase()+",")){
						console.log("Flip: "+iRow);
						var iFirstColumn =iRow.split(",")[0];
						console.log(iFirstColumn);
						var iWordArray = iFirstColumn.split(" ");
						console.log(iWordArray);
						var newAddy = iWordArray[0]

						if (iFirstColumn.split(" ")[1] == "1/2"){
							newAddy+=" 1/2 "+ iWordArray[iWordArray.length - 1];
							for (var wordIndex = 2; wordIndex < iWordArray.length - 1; ++wordIndex){
								newAddy += " " +iWordArray[wordIndex]
							}       
						} else {
							for (var wordIndex = 1; wordIndex < iRow.split(" ").length - 1; ++wordIndex){
								if (wordIndex==1){
								   newAddy += " " + iWordArray[iWordArray.length - 1]+" "+iWordArray[1];
								} else {
								   newAddy += " " +iWordArray[wordIndex]
								}
							}
						}
					}
						
					<!-- console.log(newAddy); -->
					var i = {"siteaddress": newAddy};
					items.push(i);
					addyDict[newAddy] = {"zone": iRow.split(",")[2]}
						
				}
			}

		initFilter(items);
	}
	
    file.onreadystatechange = function() {
      if (file.readyState === 4) { // Makes sure the document is ready to parse
        if (file.status === 200) { // Makes sure it's found the file
          var text = file.responseText;
		  populateList(text);
        }
      }	
    }
	file.open("GET", "https://gis.co.carver.mn.us/embedded_apps/carverlink/addy.csv", true);
	file.send()

  const initFilter = (items) => {
    filterElement.items = items;

    document.addEventListener("calciteFilterChange", () => {
      // When a Filter value is present
      // Create Cards, update Pagination, and number of responses
      if (filterElement.value) {
		console.log(filterElement.value);
		theList = [];
        filterElement.filteredItems.forEach((item) => createCard(item,filterElement.value));
		console.log(theList);
		
		const combobox = document.getElementById("address-select");
		for (var rowIndex = 0; rowIndex < theList.length; ++rowIndex){
		if (rowIndex < 15){
			var iRow = theList[rowIndex];
			const item = document.createElement("calcite-combobox-item");
			item.value = iRow;
			item.textLabel = iRow;
			combobox.appendChild(item);
			}
		}	
      }
    });

  };

/* STAGE 33 */
  /* Create Cards and their content */
  const createCard = (item,temppy="n/a") => {
  
  var iDo = true;
  if (temppy!=="n/a"){
	if (temppy != item.siteaddress.substring(0,temppy.length)){
	   console.log("Skipping: "+temppy+" <> "+item.siteaddress.substring(0,temppy.length))
	   iDo = false;
	}
  }
  if (iDo){
	theList.push(item.siteaddress)
	}
  };

  </script>
  
      <script>
  window.addEventListener('load', () => {
    const testComboBox = document.getElementById('address-select');     
    testComboBox.addEventListener("calciteComboboxChange", calciteComboboxChangeEvt => {
	var theAddress = document.getElementById('address-select').value;
	console.log(theAddress);
	<!-- if (theAddress == "Mining"){ -->
		<!-- document.getElementById('viewDiv').style.visibility = 'hidden' -->
	<!-- } else { -->
		document.getElementById('viewDiv').style.visibility = 'visible'
	<!-- } -->
    });     
    
  }, false);
</script>
    
</html>